[TOC]

## 存储器层次结构

存储器系统是一个具有不同容量，成本和访问时间的存储设备的层次系统
整体效果是一个大的储存器池，但却以接近最便宜存储设备的成本，做到了接近顶层存储设备的读写效率
存储器层次由快到慢分别为寄存器，高速缓存存储器，主存储器，慢速磁盘

### 存储技术

#### RAM
随机访问存储器(Random Access Memory)可分为**DRAM**(Dynamic)和**SRAM**(Static)两类
SRAM 使用六晶体管电路实现，具有双稳态性，只要有电就会保持它的值，在干扰结束时，也会回到稳定状态
DRAM 对干扰十分敏感，易漏电，必须周期性重写或者使用纠错码避免漏电的影响

<div align="center"><img src="https://img2024.cnblogs.com/blog/2454100/202512/2454100-20251207231110365-644764819.jpg" style="zoom:50%" alt=""/></div>

##### DRAM的读写
每个DRAM单元存储一位信息，$w$个DRAM单元组成一个超单元，再由$d$个超单元组成一个DRAM芯片
$d$个超单元构成一个$r \times c$的二维阵列，每个超单元有由行列构成的二元组地址$(i, j)$
DRAM芯片通过引脚$pin$与外部传递信息，具体来说，DRAM芯片存在一个地址引脚和一个数据引脚，通过两次在地址引脚传入确定要读写的超单元地址，通过数据引脚传递具体数据。将超单元设计为二维，减少了需要的地址引脚个数，代价是地址需要分两次传入，降低了效率

##### 内存模块
内存模块中封装了多个DRAM芯片，我们以8个8M的DRAM芯片，每个超单元存储1个字节为例
当需要访问一个地址为A的字的时候，内存控制器将A翻译成超单元地址$(i,j)$并发送到内存模块中，内存模块再将$(i,j)$广播到每一个DRAM芯片，8个芯片都取出它地址为$(i,j)$的超单元中存储的字节，再将这八个字节合并起来，传送到内存控制器中
将一个字存储在不同的DRAM芯片内的好处：通过提高并行性提高了访问效率，同时减少整个字丢失的可能，提高了可靠性

#### ROM
只读存储器(Read Only Memory) 部分的ROM读写都支持，但是所有的ROM都是非易失性的

PROM (Programmable ROM) 可编程ROM只能使用高电流编程一次
EPROM(Erasable PROM) 可擦写可编程ROM 与 EEPROM(Electrically EPROM) 电子可擦除ROM都能使用特殊手段擦除数据重新编程，但次数有限
flash memory 闪存基于EEPROM，如固态硬盘

ROM中的程序被称为固件(firmware)，在通电下运行，如PC的BIOS

#### 主存的访问
数据流通过总线(bus)在处理器和主存之间传送，读事务中数据从主存传送到处理器，写事务中数据从处理器传送到主存
处理器通过系统总线与I/O桥接器连接，主存通过内存总线与I/O桥接器连接，I/O桥接器通过将系统总线和内存总线传入的信号进行翻译
同时，I/O桥接器还连接了I/O总线，我们会在下文提到
以读事务为例

<div align="center"><img src="https://img2024.cnblogs.com/blog/2454100/202512/2454100-20251208234434127-790311577.jpg" style="zoom:40%" alt=""/></div>

#### 磁盘的存储

##### 磁盘的构造
每个磁盘包含了一个或多个**盘片**，每个盘片有着两个**盘面**，盘片绕着中心的主轴，以固定的角速度旋转
每个盘片包含了多个被称为**磁道**的同心圆，每个磁道上都有着多个用来存储信息的**扇区**，每个扇区存储的信息量大小相同，扇区间由用来标记格式化位的**间隙**分开
我们用**柱面**称呼到主轴间距相等的磁道构成的集合

<div align="center"><img src="https://img2024.cnblogs.com/blog/2454100/202512/2454100-20251208235214850-852355060.jpg" style="zoom:35%" alt=""/></div>

##### 磁盘的存储
磁盘存储的信息量取决于其面密度，即磁道数与磁道能存储的位数的乘积

为了简化控制，磁道的扇区数需要尽量保持相等
在技术不发达，面密度比较低的时期，每个磁道的扇区数完全相同，这导致外围的扇区间隙相比内围大了很多，造成了不必要的浪费
现代磁盘使用多区记录的技术，在每个**记录区**中保存了一段连续的柱面，每个记录区中的磁道扇区数相同，记录区间的扇区数不同。通过多区记录，达到了存储空间和控制难度的平衡

为什么标注1TB大小的硬盘电脑显示只有931GB？
这是制造商使用的十进制（$1TB = 1000^4$字节）与操作系统使用的二进制（$1TiB = 1024^4字节 ≈ 931GiB$）之间的差异。

##### 磁盘的读写
磁盘中的**读/写头**连接到外围的传动臂上，通过绕着传动臂转动，进行寻道以定位到某个给定的磁道上，当磁道上的某个扇区旋转到读写头正下方时，就可以对其进行读写操作

<div align="center"><img src="https://img2024.cnblogs.com/blog/2454100/202512/2454100-20251209001557526-1544401491.jpg" style="zoom:35%" alt=""/></div>

对一个扇区的访问时间，取决于一下三个部分：
1.寻道时间：传动臂将读写头移动到指定磁道的时间，这个值取决于读写头之前的位置和传动臂移动的速度
2.旋转时间：等待需要操作的扇区旋转到读写头的正下方，这取决于盘片旋转的角速度和此时目标扇区的位置
3.传送时间：这个扇区从头到尾经过读写头需要的时间，这取决于盘片旋转的角速度

计算的一个示例
<div align="center"><img src="https://img2024.cnblogs.com/blog/2454100/202512/2454100-20251209002158154-589046678.jpg" style="zoom:40%" alt=""/></div>

可见读写的时间主要取决于寻道时间和旋转时间

磁盘经过封装得到**硬盘驱动器**，简称**硬盘**，“硬盘”一词不加修饰时，通常指基于磁盘技术的机械硬盘（Hard Disk Drive, **HDD**），但需注意与固态硬盘（SSD）区分

##### 逻辑磁盘块
在逻辑上，我们可以将扇区看成一个大小为$B$的单元结构，使用一个逻辑块号进行寻址，磁盘控制器从操作系统接收这个逻辑块号，将其翻译成一个(盘面，磁道，扇区)的三元组，再对其进行寻址并进行操作

#### IO设备的连接

现代计算机系统使用PCIe（Peripheral Component Interconnect Express）总线作为主要的I/O总线标准，它取代了早期的PCI总线，将包括键鼠，图形卡，磁盘等在内的I/O设备连接到CPU和主存
有几种不同的IO设备使用I/O总线连接
1.外围I/O设备如键鼠，固态硬盘，打印机等通过通用串行主线(Universal Serial Bus,**USB**)连接到USB控制器
2.图形卡(由GPU显卡，散热器，PCB板等组成)
3.机械磁盘通过SCSI(更快更贵)或者SATA接口连接到主机主线适配器，从而连接到I/O总线
4.其他设备如网络适配器等通过主板上的拓展槽连接到I/O总线中

<div align="center"><img src="https://img2024.cnblogs.com/blog/2454100/202512/2454100-20251209222419842-1900588440.jpg" style="zoom:40%" alt=""/></div>

#### CPU与IO设备的交互
CPU通过特定的地址与I/O设备通信。这些地址可能属于独立的I/O端口地址空间，也可能被映射到物理内存地址空间中（称为内存映射I/O）
以磁盘读为例，CPU向磁盘对应的I/O端口发出三条指令，分别是指令字，逻辑块号，存放在主存中的地址
磁盘控制器接收这些信号翻译得到扇区地址，读扇区后无需CPU干涉直接将数据传输到主存，这称为直接内存访问(Direct Memory Access DMA)
磁盘读取的时间远远大于处理器执行其它指令的时间，通过直接内存访问，避免了CPU的等待
DMA传送完成后，磁盘控制器向CPU发送一个中断信号，使得CPU暂停并记录I/O操作已经完成，然后CPU继续原先的指令

<div align="center"><img src="https://img2024.cnblogs.com/blog/2454100/202512/2454100-20251209231646202-1549363798.jpg" style="zoom:35%" alt=""/></div>

#### 固态硬盘
固态硬盘(Solid State Disk, **SSD**)封装在I/O总线的插槽上(计算机内部)，采用闪存技术，一个SSD封装由一个或多个闪存芯片和一个闪存翻译器构成，其中
闪存芯片功能上类似于机械磁盘的机械驱动器，而闪存翻译器则类似于磁盘控制器

一个闪存由B个块构成，每个块内又有P个页，只有当一个页所在的块被擦除(所有位都被设置为1)才能对该页进行写，这导致SSD写的效率低于读。同时由于闪存基于EEPROM，所以写入次数有限，现代SSD采用了复杂的逻辑，减小了擦写块的时间代价，以及尝试让块的擦写尽量均匀，增加了SSD的寿命

<div align="center"><img src="https://img2024.cnblogs.com/blog/2454100/202512/2454100-20251209233320225-1045931809.jpg" style="zoom:40%" alt=""/></div>

SSD价格上比机械硬盘稍贵，并且写入次数有限，但是SSD读写速度远高于机械硬盘，并且随着SSD越来越受欢迎，其与机械硬盘价格差距也越来越小